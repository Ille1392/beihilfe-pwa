<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <title>BeihilfeCheck</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#667eea;--secondary:#764ba2;--success:#4caf50;--danger:#f44336;--warning:#ff9800;--pink:#e91e63}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);min-height:100vh;padding:10px;padding-bottom:80px}
        .container{max-width:900px;margin:0 auto}

        /* Setup Banner */
        #setupBanner{background:#fff3cd;border:2px solid #ffc107;border-radius:12px;padding:20px;margin-bottom:15px;display:none}
        #setupBanner.show{display:block}
        #setupBanner h3{color:#856404;margin-bottom:10px}
        #setupBanner p{color:#856404;margin-bottom:10px;font-size:.95em}
        #setupBanner input{width:100%;padding:10px;border:2px solid #ffc107;border-radius:8px;font-size:14px;margin-bottom:10px;font-family:monospace}
        #setupBanner .setup-btn{background:#ffc107;color:#333;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;width:100%}
        .help-box{background:#fff8e1;padding:15px;border-radius:8px;margin-top:15px}
        .help-box ol{margin-left:20px;line-height:2.2em}

        /* Header */
        .header{background:white;border-radius:15px;padding:20px;margin-bottom:15px;box-shadow:0 5px 20px rgba(0,0,0,.15);text-align:center}
        .header h1{color:var(--primary);font-size:2em;font-weight:800;margin-bottom:10px;letter-spacing:-0.5px}
        .sync-status{display:inline-flex;align-items:center;gap:8px;background:#f0f7ff;padding:8px 16px;border-radius:20px;font-size:.9em;color:var(--primary)}
        .sync-status.syncing{background:#fff3e0;color:var(--warning)}
        .sync-status.synced{background:#e8f5e9;color:var(--success)}
        .sync-status.error{background:#ffebee;color:var(--danger)}

        /* Cards & Stats */
        .card{background:white;border-radius:15px;padding:20px;margin-bottom:15px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:15px}
        .stat-card{background:white;border-radius:12px;padding:20px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,.1)}
        .stat-value{font-size:1.4em;font-weight:700;color:var(--primary);margin-top:8px}
        .stat-label{color:#666;font-size:.85em}

        /* Upload */
        .upload-section{border:3px dashed var(--primary);border-radius:10px;padding:25px;text-align:center;background:#f8f9ff;cursor:pointer;transition:all .3s;margin-bottom:20px}
        .upload-section:active{background:#e8ebff;transform:scale(.98)}
        input[type=file]{display:none}
        .upload-icon{font-size:2.5em;margin-bottom:10px}
        .preview-image{max-width:100%;max-height:150px;margin:10px 0;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1)}

        /* Form */
        .form-group{margin:15px 0}
        label{display:block;margin-bottom:8px;color:#333;font-weight:600;font-size:.95em}
        input[type=number],input[type=text],input[type=date]{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:16px;transition:border-color .3s}
        input:focus{outline:none;border-color:var(--primary)}

        /* Datum + Heute Button */
        .datum-row{display:flex;gap:10px;align-items:stretch}
        .datum-row input{flex:1}
        .heute-btn{background:var(--primary);color:white;border:none;padding:0 16px;border-radius:8px;font-size:.9em;font-weight:600;cursor:pointer;white-space:nowrap;transition:background .2s}
        .heute-btn:active{background:var(--secondary)}

        /* Beihilfesatz Buttons */
        .satz-buttons{display:flex;gap:10px;margin-top:5px}
        .satz-btn{flex:1;padding:14px 10px;border:2px solid #e0e0e0;border-radius:10px;background:white;font-size:1.1em;font-weight:700;cursor:pointer;transition:all .2s;color:#666}
        .satz-btn:active{transform:scale(.97)}
        .satz-btn.active-50{border-color:#ff9800;background:#fff3e0;color:#ff9800}
        .satz-btn.active-70{border-color:var(--pink);background:#fce4ec;color:var(--pink)}
        .satz-btn.active-80{border-color:var(--success);background:#e8f5e9;color:var(--success)}

        /* Save Button */
        .btn{background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);color:white;border:none;padding:15px;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;width:100%;transition:transform .2s;margin-top:10px}
        .btn:active{transform:scale(.98)}
        .btn:disabled{opacity:.6;cursor:not-allowed}

        /* Calculation Result */
        .calculation-result{background:#f8f9ff;border-radius:10px;padding:15px;margin-top:15px;display:none}
        .calculation-result.show{display:block}
        .result-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #e0e0e0}
        .result-row:last-child{border-bottom:none;font-weight:700;font-size:1.05em;color:var(--primary)}

        /* Beleg Items */
        .beleg-item{background:white;border:2px solid #f0f0f0;border-radius:12px;padding:15px;margin-bottom:12px;transition:border-color .3s}
        .beleg-item:hover{border-color:#ddd}
        .beleg-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px}
        .beleg-badge{display:inline-block;padding:5px 12px;border-radius:15px;font-size:.85em;font-weight:600;color:white}
        .badge-50{background:var(--warning)}
        .badge-70{background:var(--pink)}
        .badge-80{background:var(--success)}
        .beleg-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-top:10px}
        .detail-item{background:#f8f9ff;padding:10px;border-radius:6px}
        .detail-label{font-size:.8em;color:#666;margin-bottom:4px}
        .detail-value{font-weight:600;color:#333;font-size:1em}
        .delete-btn{background:var(--danger);color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:.85em}

        /* Checkboxen */
        .status-checks{display:flex;gap:15px;margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;flex-wrap:wrap}
        .check-label{display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 14px;border-radius:8px;border:2px solid #e0e0e0;background:white;font-size:.9em;font-weight:500;color:#666;transition:all .2s;flex:1;min-width:140px;justify-content:center}
        .check-label input[type=checkbox]{display:none}
        .check-label.checked-beihilfe{border-color:var(--success);background:#e8f5e9;color:var(--success)}
        .check-label.checked-pkv{border-color:var(--primary);background:#f0f4ff;color:var(--primary)}
        .check-icon{font-size:1.1em}

        /* Kein Inhalt */
        .no-belege{text-align:center;color:#999;padding:30px}

        /* Bottom Navigation */
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:white;border-top:1px solid #e0e0e0;display:flex;justify-content:space-around;padding:10px 0;box-shadow:0 -2px 10px rgba(0,0,0,.1);z-index:1000}
        .nav-item{flex:1;text-align:center;padding:8px;cursor:pointer;color:#666;font-size:.85em;transition:color .2s}
        .nav-item.active{color:var(--primary)}
        .nav-item .icon{font-size:1.5em;display:block;margin-bottom:4px}

        /* ZurÃ¼ck Button */
        .back-btn{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.2);color:white;border:none;padding:10px 16px;border-radius:10px;font-size:.95em;font-weight:600;cursor:pointer;margin-bottom:15px;backdrop-filter:blur(5px);transition:background .2s}
        .back-btn:active{background:rgba(255,255,255,.3)}

        /* Sections */
        .section{display:none}
        .section.active{display:block}

        /* Spinner */
        .spinner{display:inline-block;width:18px;height:18px;border:3px solid rgba(255,255,255,.3);border-top-color:white;border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-right:6px}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
<div class="container">

    <!-- Firebase Setup Banner -->
    <div id="setupBanner" class="show">
        <h3>âš™ï¸ Einmalige Einrichtung: Firebase Datenbank</h3>
        <p>FÃ¼gen Sie Ihre Firebase-URL ein, um Cloud-Synchronisation zwischen allen GerÃ¤ten zu aktivieren.</p>
        <input type="text" id="firebaseUrl" placeholder="https://beihilfe-app-default-rtdb.europe-west1.firebasedatabase.app">
        <button class="setup-btn" onclick="saveConfig()">âœ… Verbindung herstellen & speichern</button>
        <p style="margin-top:10px"><a href="#" id="helpLink" style="color:#856404;font-weight:600;">â“ Wie erhalte ich die Firebase-URL? (Anleitung anzeigen)</a></p>
        <div id="setupHelp" style="display:none" class="help-box">
            <b>So richten Sie Firebase ein (ca. 5 Minuten, kostenlos):</b>
            <ol>
                <li>Ã–ffnen Sie <a href="https://console.firebase.google.com" target="_blank" style="color:#856404;font-weight:bold;">console.firebase.google.com</a></li>
                <li>Klicken Sie auf <b>â€Projekt hinzufÃ¼gen"</b></li>
                <li>Projektname: <b>beihilfe-app</b> â†’ Weiter â†’ Fertig</li>
                <li>Links: <b>â€Realtime Database"</b> â†’ <b>â€Datenbank erstellen"</b></li>
                <li>Region: <b>europe-west1</b> â†’ <b>â€Im Testmodus starten"</b> â†’ Fertig</li>
                <li>URL oben kopieren (endet auf <i>.firebasedatabase.app</i>)</li>
                <li>Hier oben einfÃ¼gen â†’ <b>â€Verbindung herstellen"</b></li>
            </ol>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>âœ… BeihilfeCheck</h1>
        <div class="sync-status" id="syncStatus">
            <span id="syncIcon">â˜ï¸</span>
            <span id="syncText">Nicht verbunden</span>
        </div>
    </div>

    <!-- Ãœbersicht Sektion -->
    <div id="statsSection" class="section active">
        <div class="stats">
            <div class="stat-card"><div class="stat-label">Gesamtbetrag</div><div class="stat-value" id="totalAmount">0,00 â‚¬</div></div>
            <div class="stat-card"><div class="stat-label">Beihilfe Ã¼bernimmt</div><div class="stat-value" id="totalBeihilfe">0,00 â‚¬</div></div>
            <div class="stat-card"><div class="stat-label">PKV Ã¼bernimmt</div><div class="stat-value" id="totalPKV">0,00 â‚¬</div></div>
        </div>
        <div class="card">
            <h2 style="margin-bottom:15px;color:#333;font-size:1.3em">ğŸ“‹ Ihre Belege</h2>
            <div id="belegeListe"><div class="no-belege">Noch keine Belege erfasst</div></div>
        </div>
    </div>

    <!-- Neuer Beleg Sektion -->
    <div id="newBelegSection" class="section">
        <!-- ZurÃ¼ck Button -->
        <button class="back-btn" onclick="showSection('statsSection')">
            â† ZurÃ¼ck zur Ãœbersicht
        </button>
        <div class="card">
            <h2 style="margin-bottom:15px;color:#333;font-size:1.3em">ğŸ“„ Neuer Beleg</h2>

            <!-- Upload -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">ğŸ“</div>
                <p style="font-size:1.1em;color:var(--primary);font-weight:600">Beleg hochladen oder fotografieren</p>
                <p style="color:#999;margin-top:8px;font-size:.9em">Antippen zum AuswÃ¤hlen</p>
                <input type="file" id="fileInput" accept="image/*,.pdf" capture="environment">
            </div>
            <div id="uploadedFileName" style="color:var(--primary);font-weight:600;font-size:.9em;margin-bottom:5px"></div>
            <img id="previewImage" class="preview-image" style="display:none">

            <form id="belegForm">

                <!-- Beihilfesatz als Buttons -->
                <div class="form-group">
                    <label>Beihilfesatz *</label>
                    <div class="satz-buttons">
                        <button type="button" class="satz-btn" data-satz="50" onclick="selectSatz(50)">50%</button>
                        <button type="button" class="satz-btn" data-satz="70" onclick="selectSatz(70)">70%</button>
                        <button type="button" class="satz-btn" data-satz="80" onclick="selectSatz(80)">80%</button>
                    </div>
                    <input type="hidden" id="beihilfeSatz" value="">
                </div>

                <!-- Betrag -->
                <div class="form-group">
                    <label for="betrag">Rechnungsbetrag (â‚¬) *</label>
                    <input type="number" id="betrag" step="0.01" min="0" required placeholder="0,00">
                </div>

                <!-- Datum + Heute Button -->
                <div class="form-group">
                    <label for="datum">Rechnungsdatum *</label>
                    <div class="datum-row">
                        <input type="date" id="datum" required>
                        <button type="button" class="heute-btn" onclick="setHeute()">ğŸ“… Heute</button>
                    </div>
                </div>

                <!-- Beschreibung -->
                <div class="form-group">
                    <label for="beschreibung">Beschreibung</label>
                    <input type="text" id="beschreibung" placeholder="z.B. Zahnarzt, Apotheke...">
                </div>

                <!-- Live-Berechnung -->
                <div class="calculation-result" id="calculationResult">
                    <div class="result-row"><span>Rechnungsbetrag:</span><span id="resRechnung">0,00 â‚¬</span></div>
                    <div class="result-row"><span>Beihilfe Ã¼bernimmt:</span><span id="resBeihilfe" style="color:var(--success)">0,00 â‚¬</span></div>
                    <div class="result-row"><span>PKV Ã¼bernimmt:</span><span id="resPKV" style="color:var(--warning)">0,00 â‚¬</span></div>
                </div>

                <button type="submit" class="btn" id="saveBtn">ğŸ’¾ Beleg speichern</button>
            </form>
        </div>
    </div>

</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
    <div class="nav-item active" id="nav-stats" onclick="showSection('statsSection')">
        <span class="icon">ğŸ“Š</span><span>Ãœbersicht</span>
    </div>
    <div class="nav-item" id="nav-new" onclick="showSection('newBelegSection')">
        <span class="icon">â•</span><span>Neu</span>
    </div>
</div>

<script>
// â”€â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSection(id){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id==='statsSection') document.getElementById('nav-stats').classList.add('active');
    if(id==='newBelegSection') document.getElementById('nav-new').classList.add('active');
    window.scrollTo(0,0);
}

// â”€â”€â”€ Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let db=null;

function saveConfig(){
    let url=document.getElementById('firebaseUrl').value.trim().replace(/\/+$/,'');
    if(!url||(!url.includes('firebase')&&!url.includes('firebaseio.com'))){
        alert('âŒ UngÃ¼ltige URL!\nBitte kopieren Sie die URL direkt aus der Firebase Console.');return;
    }
    localStorage.setItem('firebaseUrl',url);
    initFirebase(url);
}

function initFirebase(url){
    try{
        if(firebase.apps.length){firebase.apps.forEach(a=>a.delete());}
        const app=firebase.initializeApp({databaseURL:url});
        db=firebase.database(app);
        db.ref('.info/connected').on('value',snap=>{
            if(snap.val()===true){
                setSyncStatus('synced','âœ…','Verbunden & synchron');
                document.getElementById('setupBanner').style.display='none';
                startSync();
            } else {
                setSyncStatus('syncing','ğŸ”„','Verbinde...');
            }
        });
    } catch(e){
        setSyncStatus('error','âŒ','Verbindungsfehler');
        alert('Fehler: '+e.message);
    }
}

function setSyncStatus(cls,icon,text){
    document.getElementById('syncStatus').className='sync-status '+cls;
    document.getElementById('syncIcon').textContent=icon;
    document.getElementById('syncText').textContent=text;
}

function startSync(){
    db.ref('belege').on('value',snap=>{
        const data=snap.val()||{};
        const belege=Object.values(data).sort((a,b)=>new Date(b.erstellt)-new Date(a.erstellt));
        renderBelege(belege);
        updateStats(belege);
    });
}

// â”€â”€â”€ Beihilfesatz Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedSatz=null;

function selectSatz(satz){
    selectedSatz=satz;
    document.getElementById('beihilfeSatz').value=satz;
    document.querySelectorAll('.satz-btn').forEach(btn=>{
        btn.className='satz-btn';
        if(parseInt(btn.dataset.satz)===satz) btn.classList.add('active-'+satz);
    });
    calc();
}

// â”€â”€â”€ Datum: Heute Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setHeute(){
    const today=new Date();
    const y=today.getFullYear();
    const m=String(today.getMonth()+1).padStart(2,'0');
    const d=String(today.getDate()).padStart(2,'0');
    document.getElementById('datum').value=`${y}-${m}-${d}`;
}

// â”€â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let imgBase64=null,fileName=null;
document.getElementById('uploadSection').addEventListener('click',()=>document.getElementById('fileInput').click());
document.getElementById('fileInput').addEventListener('change',e=>{
    const f=e.target.files[0];if(!f)return;
    fileName=f.name;
    document.getElementById('uploadedFileName').textContent='ğŸ“ '+f.name;
    if(f.type.startsWith('image/')){
        const r=new FileReader();
        r.onload=ev=>{imgBase64=ev.target.result;const img=document.getElementById('previewImage');img.src=ev.target.result;img.style.display='block';};
        r.readAsDataURL(f);
    } else {imgBase64=null;document.getElementById('previewImage').style.display='none';}
});

// â”€â”€â”€ Live-Berechnung â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calc(){
    const b=parseFloat(document.getElementById('betrag').value)||0;
    if(!selectedSatz||b<=0){document.getElementById('calculationResult').classList.remove('show');return;}
    const pct=selectedSatz/100;
    document.getElementById('resRechnung').textContent=eur(b);
    document.getElementById('resBeihilfe').textContent=eur(b*pct);
    document.getElementById('resPKV').textContent=eur(b*(1-pct));
    document.getElementById('calculationResult').classList.add('show');
}
document.getElementById('betrag').addEventListener('input',calc);

// â”€â”€â”€ Formular Speichern â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('belegForm').addEventListener('submit',async e=>{
    e.preventDefault();
    if(!db){alert('âš ï¸ Bitte zuerst Firebase einrichten!');return;}
    if(!selectedSatz){alert('âš ï¸ Bitte Beihilfesatz auswÃ¤hlen (50%, 70% oder 80%)!');return;}
    const btn=document.getElementById('saveBtn');
    btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Speichere...';
    const betrag=parseFloat(document.getElementById('betrag').value);
    const pct=selectedSatz/100;
    const id=Date.now().toString();
    const beleg={
        id, betrag,
        beihilfeSatz: selectedSatz,
        datum: document.getElementById('datum').value,
        beschreibung: document.getElementById('beschreibung').value,
        beihilfeBetrag: betrag*pct,
        pkvBetrag: betrag*(1-pct),
        dateiname: fileName,
        image: imgBase64,
        beihilfeBezahlt: false,
        pkvBezahlt: false,
        erstellt: new Date().toISOString()
    };
    try{
        await db.ref('belege/'+id).set(beleg);
        e.target.reset();
        document.getElementById('calculationResult').classList.remove('show');
        document.getElementById('uploadedFileName').textContent='';
        document.getElementById('previewImage').style.display='none';
        imgBase64=null;fileName=null;selectedSatz=null;
        document.querySelectorAll('.satz-btn').forEach(b=>b.className='satz-btn');
        showSection('statsSection');
    } catch(err){
        alert('âŒ Fehler beim Speichern: '+err.message);
    }
    btn.disabled=false;btn.innerHTML='ğŸ’¾ Beleg speichern';
});

// â”€â”€â”€ Status Checkboxen umschalten â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.toggleStatus=async function(id, field, val){
    if(!db)return;
    try{
        await db.ref('belege/'+id+'/'+field).set(val);
    } catch(e){alert('Fehler: '+e.message);}
};

// â”€â”€â”€ Beleg lÃ¶schen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.deleteBeleg=async function(id){
    if(!confirm('Beleg wirklich lÃ¶schen?'))return;
    try{await db.ref('belege/'+id).remove();}catch(e){alert('Fehler: '+e.message);}
};

// â”€â”€â”€ Belege rendern â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBelege(belege){
    const el=document.getElementById('belegeListe');
    if(!belege.length){el.innerHTML='<div class="no-belege">Noch keine Belege erfasst.<br><br>Tippen Sie unten auf â•</div>';return;}
    el.innerHTML=belege.map(b=>`
        <div class="beleg-item" id="item-${b.id}">
            <div class="beleg-header">
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                    <span class="beleg-badge badge-${b.beihilfeSatz||b.beihilfeProzent}">${b.beihilfeSatz||b.beihilfeProzent}% Beihilfe</span>
                    ${b.beschreibung?`<span style="color:#666;font-size:.9em">${b.beschreibung}</span>`:''}
                </div>
                <button class="delete-btn" onclick="deleteBeleg('${b.id}')">ğŸ—‘ï¸</button>
            </div>
            ${b.dateiname?`<div style="color:#999;font-size:.85em;margin-bottom:8px">ğŸ“ ${b.dateiname}</div>`:''}
            ${b.image?`<img src="${b.image}" class="preview-image" style="display:block;margin-bottom:10px">`:''}
            <div style="color:#999;font-size:.85em;margin-bottom:10px">ğŸ“… ${datFmt(b.datum)}</div>
            <div class="beleg-details">
                <div class="detail-item">
                    <div class="detail-label">Rechnungsbetrag</div>
                    <div class="detail-value">${eur(b.betrag)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Beihilfe (${b.beihilfeSatz||b.beihilfeProzent}%)</div>
                    <div class="detail-value" style="color:var(--success)">${eur(b.beihilfeBetrag)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">PKV (${100-(b.beihilfeSatz||b.beihilfeProzent)}%)</div>
                    <div class="detail-value" style="color:var(--warning)">${eur(b.pkvBetrag)}</div>
                </div>
            </div>
            <!-- Status Checkboxen -->
            <div class="status-checks">
                <label class="check-label ${b.beihilfeBezahlt?'checked-beihilfe':''}" id="lbl-beihilfe-${b.id}" onclick="handleCheck('${b.id}','beihilfeBezahlt',${!b.beihilfeBezahlt})">
                    <span class="check-icon">${b.beihilfeBezahlt?'âœ…':'â¬œ'}</span>
                    Beihilfe bezahlt
                </label>
                <label class="check-label ${b.pkvBezahlt?'checked-pkv':''}" id="lbl-pkv-${b.id}" onclick="handleCheck('${b.id}','pkvBezahlt',${!b.pkvBezahlt})">
                    <span class="check-icon">${b.pkvBezahlt?'âœ…':'â¬œ'}</span>
                    PKV bezahlt
                </label>
            </div>
        </div>`).join('');
}

window.handleCheck=function(id,field,newVal){
    toggleStatus(id,field,newVal);
};

// â”€â”€â”€ Statistiken â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats(belege){
    document.getElementById('totalAmount').textContent=eur(belege.reduce((s,b)=>s+b.betrag,0));
    document.getElementById('totalBeihilfe').textContent=eur(belege.reduce((s,b)=>s+b.beihilfeBetrag,0));
    document.getElementById('totalPKV').textContent=eur(belege.reduce((s,b)=>s+b.pkvBetrag,0));
}

// â”€â”€â”€ Hilfsfunktionen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function eur(v){return new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(v);}
function datFmt(d){return new Date(d).toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'});}

// â”€â”€â”€ Help Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('helpLink').addEventListener('click',e=>{
    e.preventDefault();
    const h=document.getElementById('setupHelp');
    h.style.display=h.style.display==='none'?'block':'none';
});

// â”€â”€â”€ Auto-Connect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const saved=localStorage.getItem('firebaseUrl');
if(saved){document.getElementById('firebaseUrl').value=saved;initFirebase(saved);}
</script>
</body>
</html>
