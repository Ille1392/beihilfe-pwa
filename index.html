<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#00c9a7">
<link rel="manifest" href="manifest.json">
<title>BeihilfeCheck</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Nunito+Sans:wght@400;600;700&family=DM+Serif+Display&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPLASH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#splashScreen{position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;background:linear-gradient(135deg,#00c9a7 0%,#4facfe 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:1;transition:opacity .5s}
#splashScreen.hide{opacity:0;pointer-events:none}
.splash-logo{width:100px;height:100px;animation:pulse 1.5s ease-in-out infinite}
.splash-title{font-family:'Nunito',sans-serif;font-size:2.5em;font-weight:900;color:white;margin-top:20px;letter-spacing:-1px;text-shadow:0 2px 20px rgba(0,0,0,.2)}
.splash-subtitle{font-family:'Nunito Sans',sans-serif;font-size:1em;color:rgba(255,255,255,.9);margin-top:8px;letter-spacing:1px;text-transform:uppercase;font-weight:600}
.splash-loader{margin-top:40px;width:50px;height:50px;border:4px solid rgba(255,255,255,.2);border-top-color:white;border-radius:50%;animation:spin 1s linear infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes spin{to{transform:rotate(360deg)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loginScreen{position:fixed;top:0;left:0;right:0;bottom:0;z-index:9998;background:linear-gradient(135deg,#00c9a7 0%,#4facfe 100%);display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px}
#loginScreen.show{display:flex}
.login-card{background:white;border-radius:24px;padding:40px 30px;max-width:400px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,.2);text-align:center}
.login-logo{width:80px;height:80px;margin:0 auto 20px}
.login-title{font-family:'Nunito',sans-serif;font-size:2em;font-weight:900;color:#2d3748;margin-bottom:8px}
.login-subtitle{font-size:.95em;color:#718096;margin-bottom:30px}
.google-btn{background:white;border:2px solid #e8edf3;border-radius:12px;padding:14px 24px;font-family:'Nunito Sans',sans-serif;font-size:1em;font-weight:700;color:#2d3748;cursor:pointer;width:100%;display:flex;align-items:center;justify-content:center;gap:12px;transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.google-btn:hover{border-color:#00c9a7;box-shadow:0 4px 12px rgba(0,201,167,.2)}
.google-btn:active{transform:scale(.98)}
.google-icon{width:24px;height:24px}
.login-footer{margin-top:20px;font-size:.85em;color:#718096}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME VARIABLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root,[data-theme="light"]{--bg:#f0f4f8;--surface:#ffffff;--surface2:#fafbfc;--border:#e8edf3;--text:#2d3748;--muted:#718096;--shadow:0 2px 16px rgba(0,0,0,.07);--accent:#00c9a7;--accent-dim:#00a589;--accent-light:#e0faf5;--accent2:#4facfe;--accent2-light:#e8f4ff;--green:#00a589;--green-bg:#e0faf5;--orange:#ffa94d;--orange-bg:#fff4e6;--red:#ff6b6b;--red-bg:#fff0f0;--blue:#4facfe;--blue-bg:#e8f4ff;--badge50-bg:#fff4e6;--badge50-color:#ffa94d;--badge70-bg:#fff0f0;--badge70-color:#ff6b6b;--badge80-bg:#e0faf5;--badge80-color:#00a589;--satz50-border:#ffa94d;--satz50-bg:#fff4e6;--satz50-color:#ffa94d;--satz70-border:#ff6b6b;--satz70-bg:#fff0f0;--satz70-color:#ff6b6b;--satz80-border:#00c9a7;--satz80-bg:#e0faf5;--satz80-color:#00a589;--stat1-color:#00a589;--save-bg:linear-gradient(135deg,#00c9a7,#4facfe);--save-shadow:rgba(0,201,167,.35);--logo-font:'Nunito',sans-serif;--body-font:'Nunito Sans',sans-serif;--logo-accent:#00c9a7;--heute-bg:#e8f4ff;--heute-color:#4facfe;--heute-border:rgba(79,172,254,.4);--check-beihilfe-bg:#e0faf5;--check-beihilfe-border:rgba(0,201,167,.4);--check-beihilfe-color:#00a589;--check-pkv-bg:#e8f4ff;--check-pkv-border:rgba(79,172,254,.4);--check-pkv-color:#4facfe;--nav-active:#00a589;--back-bg:rgba(255,255,255,.9);--back-color:#2d3748;--toggle-bg:#2d3748;--toggle-color:#fff}
[data-theme="dark"]{--bg:#0f1117;--surface:#1a1d27;--surface2:#222536;--border:#2d3148;--text:#e8eaf0;--muted:#6b7280;--shadow:0 2px 16px rgba(0,0,0,.3);--accent:#f0c060;--accent-dim:#c49a30;--accent-light:rgba(240,192,96,.08);--accent2:#60a5fa;--accent2-light:rgba(96,165,250,.08);--green:#34d399;--green-bg:rgba(52,211,153,.08);--orange:#f0c060;--orange-bg:rgba(240,192,96,.08);--red:#f87171;--red-bg:rgba(248,113,113,.08);--blue:#60a5fa;--blue-bg:rgba(96,165,250,.08);--badge50-bg:rgba(240,192,96,.1);--badge50-color:#f0c060;--badge70-bg:rgba(96,165,250,.1);--badge70-color:#60a5fa;--badge80-bg:rgba(52,211,153,.1);--badge80-color:#34d399;--satz50-border:#f0c060;--satz50-bg:rgba(240,192,96,.08);--satz50-color:#f0c060;--satz70-border:#60a5fa;--satz70-bg:rgba(96,165,250,.08);--satz70-color:#60a5fa;--satz80-border:#34d399;--satz80-bg:rgba(52,211,153,.08);--satz80-color:#34d399;--stat1-color:#f0c060;--save-bg:linear-gradient(135deg,#f0c060,#e8a820);--save-shadow:rgba(240,192,96,.25);--logo-font:'DM Serif Display',serif;--body-font:'DM Sans',sans-serif;--logo-accent:#f0c060;--heute-bg:rgba(96,165,250,.08);--heute-color:#60a5fa;--heute-border:rgba(96,165,250,.3);--check-beihilfe-bg:rgba(52,211,153,.08);--check-beihilfe-border:rgba(52,211,153,.3);--check-beihilfe-color:#34d399;--check-pkv-bg:rgba(96,165,250,.08);--check-pkv-border:rgba(96,165,250,.3);--check-pkv-color:#60a5fa;--nav-active:#f0c060;--back-bg:rgba(26,29,39,.9);--back-color:#e8eaf0;--toggle-bg:#f0c060;--toggle-color:#0f1117}

/* BASE */
body{font-family:var(--body-font);background:var(--bg);color:var(--text);min-height:100vh;padding:12px;padding-bottom:90px;transition:background .3s,color .3s}
.container{max-width:520px;margin:0 auto}
.theme-toggle{position:fixed;top:14px;right:14px;z-index:999;background:var(--toggle-bg);color:var(--toggle-color);border:none;width:44px;height:44px;border-radius:50%;font-size:1.2em;cursor:pointer;box-shadow:0 2px 12px rgba(0,0,0,.2);transition:all .3s;display:flex;align-items:center;justify-content:center}
.theme-toggle:active{transform:scale(.9)}

/* HEADER */
.app-header{background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:20px 20px 16px;margin-bottom:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:center;gap:12px;transition:background .3s,border-color .3s;position:relative;overflow:hidden}
.logo-wrap{display:flex;align-items:center;gap:12px;padding-right:44px}
.logo-svg{width:52px;height:52px;transition:all .3s;flex-shrink:0}
.logo-text .logo-title{font-family:var(--logo-font);font-size:1.75em;color:var(--text);line-height:1;letter-spacing:-.3px;font-weight:900;transition:font-family .3s}
[data-theme="dark"] .logo-text .logo-title{font-weight:400}
.logo-text .logo-title span{color:var(--accent);transition:color .3s}
.logo-text .logo-sub{font-size:.72em;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-top:3px;font-weight:600}
.user-info{display:flex;align-items:center;gap:10px;font-size:.85em;color:var(--muted)}
.user-avatar{width:32px;height:32px;border-radius:50%;border:2px solid var(--border)}
.logout-btn{background:var(--red-bg);color:var(--red);border:1px solid rgba(248,113,113,.2);padding:6px 12px;border-radius:8px;cursor:pointer;font-size:.8em;font-weight:600;font-family:var(--body-font);margin-top:8px}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:15px 8px;text-align:center;box-shadow:var(--shadow);transition:all .3s}
.stat-icon{font-size:1.3em;margin-bottom:5px}
.stat-val{font-family:var(--logo-font);font-size:1.1em;font-weight:800;color:var(--stat1-color);margin-bottom:3px;transition:all .3s}
[data-theme="dark"] .stat-val{font-weight:400}
.stat-val.sv2{color:var(--green)}
.stat-val.sv3{color:var(--blue)}
.stat-lbl{font-size:.7em;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}

/* CARD */
.card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:20px;margin-bottom:14px;box-shadow:var(--shadow);transition:background .3s,border-color .3s}
.card-title{font-size:1.05em;font-weight:700;color:var(--text);margin-bottom:16px;display:flex;align-items:center;gap:8px}

/* UPLOAD */
.upload-area{border:2px dashed var(--border);border-radius:14px;padding:22px;text-align:center;background:var(--surface2);cursor:pointer;transition:all .2s;margin-bottom:16px}
.upload-area:active,.upload-area.over{border-color:var(--accent);background:var(--accent-light)}
.upload-area .u-icon{font-size:2em;margin-bottom:7px}
.upload-area .u-title{font-weight:700;color:var(--accent-dim);font-size:.92em}
.upload-area .u-hint{font-size:.78em;color:var(--muted);margin-top:4px}
input[type=file]{display:none}
.preview-img{max-width:100%;max-height:140px;border-radius:10px;margin:10px 0;box-shadow:0 2px 8px rgba(0,0,0,.1)}

/* FORM */
.form-group{margin-bottom:14px}
.form-label{font-size:.77em;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;margin-bottom:8px;display:block}
input[type=number],input[type=text],input[type=date],select{width:100%;padding:13px 14px;border:1.5px solid var(--border);border-radius:12px;font-size:.97em;font-family:var(--body-font);color:var(--text);background:var(--surface2);transition:all .2s}
input:focus,select:focus{outline:none;border-color:var(--accent-dim)}
input::placeholder{color:var(--muted)}

.datum-row{display:flex;gap:8px}
.datum-row input{flex:1}
.heute-btn{background:var(--heute-bg);color:var(--heute-color);border:1.5px solid var(--heute-border);border-radius:12px;padding:0 14px;font-weight:700;font-size:.83em;cursor:pointer;white-space:nowrap;transition:all .2s;font-family:var(--body-font)}
.heute-btn:active{background:var(--heute-color);color:var(--surface)}

/* SATZ BUTTONS */
.satz-group{display:flex;gap:8px}
.satz-btn{flex:1;padding:13px 4px;border:1.5px solid var(--border);border-radius:12px;background:var(--surface2);color:var(--muted);font-family:var(--body-font);font-weight:700;font-size:1.08em;cursor:pointer;transition:all .2s;text-align:center}
.satz-btn .satz-sub{display:block;font-size:.6em;font-weight:500;margin-top:3px;opacity:.7}
.satz-btn.s50{border-color:var(--satz50-border);background:var(--satz50-bg);color:var(--satz50-color)}
.satz-btn.s70{border-color:var(--satz70-border);background:var(--satz70-bg);color:var(--satz70-color)}
.satz-btn.s80{border-color:var(--satz80-border);background:var(--satz80-bg);color:var(--satz80-color)}

/* CALC */
.calc-box{background:var(--surface2);border:1.5px solid var(--border);border-radius:14px;padding:15px;margin-top:14px;display:none;transition:all .3s}
.calc-box.show{display:block}
.calc-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);font-size:.9em}
.calc-row:last-child{border:none;font-weight:700;font-size:.95em}
.calc-row span:first-child{color:var(--muted)}

/* SAVE BTN */
.save-btn{width:100%;padding:15px;border:none;border-radius:14px;margin-top:12px;background:var(--save-bg);color:var(--surface);font-family:var(--body-font);font-weight:700;font-size:1em;cursor:pointer;transition:all .15s;box-shadow:0 4px 20px var(--save-shadow)}
[data-theme="dark"] .save-btn{color:#0f1117}
.save-btn:active{transform:scale(.98);box-shadow:none}
.save-btn:disabled{opacity:.5;cursor:not-allowed}

/* BELEG ITEMS */
.beleg-item{border:1.5px solid var(--border);border-radius:16px;padding:15px;margin-bottom:10px;background:var(--surface);transition:all .3s}
.beleg-item:hover{border-color:var(--accent-dim)}
.beleg-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.beleg-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:.78em;font-weight:700}
.badge-50{background:var(--badge50-bg);color:var(--badge50-color)}
.badge-70{background:var(--badge70-bg);color:var(--badge70-color)}
.badge-80{background:var(--badge80-bg);color:var(--badge80-color)}
.beleg-desc{font-size:.88em;color:var(--text);font-weight:600;margin-top:5px}
.beleg-date{font-size:.76em;color:var(--muted);margin-top:3px}
.del-btn{background:var(--red-bg);color:var(--red);border:1px solid rgba(248,113,113,.2);padding:7px 12px;border-radius:8px;cursor:pointer;font-size:.82em;font-weight:600;font-family:var(--body-font)}

.beleg-amounts{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
.amt-item{background:var(--surface2);border-radius:10px;padding:10px;text-align:center;border:1px solid var(--border)}
.amt-lbl{font-size:.7em;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px}
.amt-val{font-family:var(--logo-font);font-size:.92em;font-weight:800;color:var(--text)}
[data-theme="dark"] .amt-val{font-weight:400}
.amt-val.av-accent{color:var(--stat1-color)}
.amt-val.av-green{color:var(--green)}
.amt-val.av-blue{color:var(--blue)}

.status-row{display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1.5px solid var(--border)}
.check-toggle{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:9px 8px;border-radius:10px;border:1.5px solid var(--border);background:var(--surface2);font-size:.8em;font-weight:600;cursor:pointer;transition:all .2s;color:var(--muted);font-family:var(--body-font)}
.check-toggle.on-b{background:var(--check-beihilfe-bg);border-color:var(--check-beihilfe-border);color:var(--check-beihilfe-color)}
.check-toggle.on-p{background:var(--check-pkv-bg);border-color:var(--check-pkv-border);color:var(--check-pkv-color)}

/* ZURÃœCK */
.back-btn{display:inline-flex;align-items:center;gap:6px;background:var(--back-bg);color:var(--back-color);border:1px solid var(--border);padding:10px 16px;border-radius:12px;font-weight:600;font-size:.88em;cursor:pointer;margin-bottom:14px;transition:all .2s;box-shadow:var(--shadow);backdrop-filter:blur(8px);font-family:var(--body-font)}
.back-btn:active{border-color:var(--accent)}

/* NAV */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1.5px solid var(--border);display:flex;padding:8px 0 14px;box-shadow:0 -4px 20px rgba(0,0,0,.07);z-index:100;transition:background .3s,border-color .3s}
.nav-tab{flex:1;text-align:center;padding:6px;cursor:pointer;color:var(--muted);transition:color .2s}
.nav-tab.active{color:var(--nav-active)}
.nav-tab .ni{font-size:1.35em;display:block;margin-bottom:2px}
.nav-tab .nl{font-size:.72em;font-weight:700;text-transform:uppercase;letter-spacing:.4px}
.section{display:none}.section.active{display:block}
.no-belege{text-align:center;color:var(--muted);padding:30px;font-size:.92em}
.spinner{display:inline-block;width:15px;height:15px;border:2.5px solid rgba(0,0,0,.15);border-top-color:currentColor;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px}
[data-theme="dark"] .spinner{border:2.5px solid rgba(255,255,255,.15);border-top-color:currentColor}
.file-name{color:var(--accent-dim);font-weight:600;font-size:.87em;margin-bottom:6px}

/* PERSONEN */
.person-item{background:var(--surface2);border:1.5px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;transition:border-color .2s}
.person-item:hover{border-color:var(--accent-dim)}
.person-name{font-weight:700;font-size:.95em;color:var(--text)}
.person-satz{font-size:.85em;color:var(--muted);margin-top:2px}
.person-del{background:var(--red-bg);color:var(--red);border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-size:.8em;font-weight:600}

/* OCR PROGRESS */
.ocr-progress{background:var(--surface2);border:1.5px solid var(--border);border-radius:12px;padding:16px;margin-bottom:14px}
.ocr-item{padding:10px 0;border-bottom:1px solid var(--border)}
.ocr-item:last-child{border:none}
.ocr-status{font-size:.85em;color:var(--muted);display:flex;align-items:center;gap:8px}
.ocr-status.done{color:var(--green)}
.ocr-status.processing{color:var(--accent)}

/* UPLOAD PREVIEW */
.upload-preview{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-bottom:14px}
.upload-preview-item{position:relative;border-radius:10px;overflow:hidden;aspect-ratio:1;border:2px solid var(--border)}
.upload-preview-item img{width:100%;height:100%;object-fit:cover}
.upload-preview-remove{position:absolute;top:4px;right:4px;background:var(--red);color:white;border:none;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:.8em}

/* ZUORDNUNG */
.zuordnung-card{background:var(--surface2);border:1.5px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px}
.zuordnung-img{width:80px;height:80px;object-fit:cover;border-radius:8px;margin-bottom:10px}
.zuordnung-betrag{font-weight:700;font-size:1.1em;color:var(--text);margin-bottom:8px}
.zuordnung-suggestion{background:var(--green-bg);color:var(--green);padding:6px 12px;border-radius:8px;font-size:.85em;display:inline-block;margin-bottom:10px}
.zuordnung-dropdown{width:100%;padding:10px;border:1.5px solid var(--border);border-radius:8px;font-size:.9em;background:var(--surface)}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splashScreen">
<svg class="splash-logo" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect width="100" height="100" rx="24" fill="white" fill-opacity=".2"/>
<path d="M50 20 L75 30 L75 52 C75 66 62.5 78 50 84 C37.5 78 25 66 25 52 L25 30 Z" fill="white" opacity=".3"/>
<path d="M50 16 L78 28 L78 52 C78 68.5 65.5 82 50 88 C34.5 82 22 68.5 22 52 L22 28 Z" stroke="white" stroke-width="3" fill="none"/>
<path d="M38 52 L46 60 L62 44" stroke="white" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
<div class="splash-title">BeihilfeCheck</div>
<div class="splash-subtitle">Belege verwalten</div>
<div class="splash-loader"></div>
</div>

<!-- LOGIN -->
<div id="loginScreen">
<div class="login-card">
<svg class="login-logo" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect width="80" height="80" rx="20" fill="url(#lgl)"/>
<path d="M40 16 L60 24 L60 42 C60 53 50 62 40 67 C30 62 20 53 20 42 L20 24 Z" fill="white" opacity=".2"/>
<path d="M40 13 L63 22 L63 42 C63 54.5 52.5 65 40 70 C27.5 65 17 54.5 17 42 L17 22 Z" stroke="white" stroke-width="2.5" fill="none" opacity=".5"/>
<path d="M30 42 L37 49 L50 36" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
<defs><linearGradient id="lgl" x1="0" y1="0" x2="80" y2="80" gradientUnits="userSpaceOnUse"><stop stop-color="#00c9a7"/><stop offset="1" stop-color="#4facfe"/></linearGradient></defs>
</svg>
<div class="login-title">BeihilfeCheck</div>
<div class="login-subtitle">Melden Sie sich an, um Ihre Belege zu verwalten</div>
<button class="google-btn" id="googleLoginBtn">
<svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
Mit Google anmelden
</button>
<div class="login-footer">Sicher & kostenlos</div>
</div>
</div>

<!-- MAIN APP -->
<div class="container" id="mainApp" style="display:none">

<button class="theme-toggle" id="themeToggle" title="Design wechseln">ğŸŒ™</button>

<div class="app-header">
<div class="logo-wrap">
<svg class="logo-svg" id="logoLight" viewBox="0 0 52 52" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect width="52" height="52" rx="14" fill="url(#lg1)"/>
<path d="M26 10 L38 15 L38 26 C38 33 32 39 26 42 C20 39 14 33 14 26 L14 15 Z" fill="white" opacity=".15"/>
<path d="M26 8 L40 14 L40 26 C40 34.5 33.5 41 26 44 C18.5 41 12 34.5 12 26 L12 14 Z" stroke="white" stroke-width="2" fill="none" opacity=".5"/>
<path d="M20 26 L24 30 L32 22" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
<defs><linearGradient id="lg1" x1="0" y1="0" x2="52" y2="52" gradientUnits="userSpaceOnUse"><stop stop-color="#00c9a7"/><stop offset="1" stop-color="#4facfe"/></linearGradient></defs>
</svg>
<svg class="logo-svg" id="logoDark" style="display:none" viewBox="0 0 52 52" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect width="52" height="52" rx="14" fill="#1a1d27"/>
<rect x=".5" y=".5" width="51" height="51" rx="13.5" stroke="#f0c060" stroke-opacity=".4"/>
<path d="M26 10 L38 15 L38 26 C38 33 32 39 26 42 C20 39 14 33 14 26 L14 15 Z" fill="url(#lg2)" opacity=".15"/>
<path d="M26 8 L40 14 L40 26 C40 34.5 33.5 41 26 44 C18.5 41 12 34.5 12 26 L12 14 Z" stroke="url(#lg2)" stroke-width="1.5" fill="none"/>
<path d="M20 26 L24 30 L32 22" stroke="url(#lg2)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
<defs><linearGradient id="lg2" x1="12" y1="8" x2="40" y2="44" gradientUnits="userSpaceOnUse"><stop stop-color="#f0c060"/><stop offset="1" stop-color="#e8a820"/></linearGradient></defs>
</svg>
<div class="logo-text">
<div class="logo-title">Beihilfe<span>Check</span></div>
<div class="logo-sub">Belege verwalten</div>
</div>
</div>
<div class="user-info">
<img class="user-avatar" id="userAvatar" src="" alt="">
<span id="userName"></span>
</div>
<button class="logout-btn" id="logoutBtn">Abmelden</button>
</div>

<!-- ÃœBERSICHT -->
<div id="statsSection" class="section active">
<div class="stats-grid">
<div class="stat-card"><div class="stat-icon">ğŸ§¾</div><div class="stat-val" id="totalAmount">0 â‚¬</div><div class="stat-lbl">Gesamt</div></div>
<div class="stat-card"><div class="stat-icon">ğŸ›ï¸</div><div class="stat-val sv2" id="totalBeihilfe">0 â‚¬</div><div class="stat-lbl">Beihilfe</div></div>
<div class="stat-card"><div class="stat-icon">ğŸ’Š</div><div class="stat-val sv3" id="totalPKV">0 â‚¬</div><div class="stat-lbl">PKV</div></div>
</div>
<div class="card">
<div class="card-title">ğŸ“‹ Ihre Belege</div>
<div id="belegeListe"><div class="no-belege">Noch keine Belege.<br>Tippen Sie unten auf â•</div></div>
</div>
</div>

<!-- PERSONEN -->
<div id="personenSection" class="section">
<button class="back-btn" onclick="showSection('statsSection')">â† ZurÃ¼ck</button>
<div class="card">
<div class="card-title">ğŸ‘¥ Personen verwalten</div>
<div id="personenListe"></div>
<div class="form-group">
<label class="form-label">Name *</label>
<input type="text" id="newPersonName" placeholder="z.B. Max Mustermann">
</div>
<div class="form-group">
<label class="form-label">Beihilfesatz *</label>
<div class="satz-group">
<button type="button" class="satz-btn" data-s="50" onclick="selectNewPersonSatz(50)">50%</button>
<button type="button" class="satz-btn" data-s="70" onclick="selectNewPersonSatz(70)">70%</button>
<button type="button" class="satz-btn" data-s="80" onclick="selectNewPersonSatz(80)">80%</button>
</div>
<input type="hidden" id="newPersonSatz">
</div>
<button class="save-btn" onclick="addPerson()">â• Person hinzufÃ¼gen</button>
</div>
</div>

<!-- NEUER BELEG MIT OCR -->
<div id="newBelegSection" class="section">
<button class="back-btn" onclick="showSection('statsSection')">â† ZurÃ¼ck</button>
<div class="card">
<div class="card-title">ğŸ“„ Neue Belege (OCR)</div>
<div class="upload-area" id="uploadArea">
<div class="u-icon">ğŸ“</div>
<div class="u-title">Rechnungen hochladen oder fotografieren</div>
<div class="u-hint">Mehrere Dateien gleichzeitig mÃ¶glich â€¢ OCR erkennt automatisch</div>
<input type="file" id="fileInput" accept="image/*" capture="environment" multiple>
</div>
<div id="uploadPreview" class="upload-preview"></div>
<div id="ocrProgress" class="ocr-progress" style="display:none"></div>
<div id="zuordnungContainer"></div>
<button class="save-btn" id="saveBelegeBtn" style="display:none" onclick="saveBelege()">ğŸ’¾ Alle Belege speichern</button>
</div>
</div>

<!-- MANUELLER MODUS -->
<div id="manualSection" class="section">
<button class="back-btn" onclick="showSection('statsSection')">â† ZurÃ¼ck</button>
<div class="card">
<div class="card-title">âœï¸ Beleg manuell erfassen</div>
<div class="upload-area" id="manualUploadArea">
<div class="u-icon">ğŸ“</div>
<div class="u-title">Beleg hochladen oder fotografieren</div>
<div class="u-hint">Einzelne Datei â€¢ Keine OCR â€¢ Schneller</div>
<input type="file" id="manualFileInput" accept="image/*,.pdf" capture="environment">
</div>
<div id="manualUploadedName" class="file-name"></div>
<img id="manualPreviewImg" class="preview-img" style="display:none">
<form id="manualBelegForm">
<div class="form-group">
<label class="form-label">Person *</label>
<select id="manualPerson" required>
<option value="">-- Bitte wÃ¤hlen --</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Rechnungsbetrag (â‚¬) *</label>
<input type="number" id="manualBetrag" step="0.01" min="0" placeholder="0,00" required>
</div>
<div class="form-group">
<label class="form-label">Datum *</label>
<div class="datum-row">
<input type="date" id="manualDatum" required>
<button type="button" class="heute-btn" onclick="setManualHeute()">ğŸ“… Heute</button>
</div>
</div>
<div class="form-group">
<label class="form-label">Beschreibung</label>
<input type="text" id="manualBeschreibung" placeholder="z.B. Zahnarzt, Apotheke...">
</div>
<div class="calc-box" id="manualCalcBox">
<div class="calc-row"><span>Rechnungsbetrag</span><span id="manualRR" style="color:var(--text)">â€“</span></div>
<div class="calc-row"><span>ğŸ›ï¸ Beihilfe Ã¼bernimmt</span><span id="manualRB" style="color:var(--green)">â€“</span></div>
<div class="calc-row"><span>ğŸ’Š PKV Ã¼bernimmt</span><span id="manualRP" style="color:var(--blue)">â€“</span></div>
</div>
<button type="submit" class="save-btn" id="manualSaveBtn">ğŸ’¾ Beleg speichern</button>
</form>
</div>
</div>

</div>

<div class="bottom-nav" id="bottomNav" style="display:none">
<div class="nav-tab active" id="nav-stats" onclick="showSection('statsSection')"><span class="ni">ğŸ“Š</span><span class="nl">Ãœbersicht</span></div>
<div class="nav-tab" id="nav-personen" onclick="showSection('personenSection')"><span class="ni">ğŸ‘¥</span><span class="nl">Personen</span></div>
<div class="nav-tab" id="nav-new" onclick="showSection('newBelegSection')"><span class="ni">ğŸ¤–</span><span class="nl">OCR</span></div>
<div class="nav-tab" id="nav-manual" onclick="showSection('manualSection')"><span class="ni">âœï¸</span><span class="nl">Manuell</span></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG - HIER EINTRAGEN!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyBqPgA_mWZBTbQfuZ_l3w9C4ElD6F6rO-Y",
  authDomain: "beihilfe-app.firebaseapp.com",
  databaseURL: "https://beihilfe-app-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "beihilfe-app",
  storageBucket: "beihilfe-app.firebasestorage.app",
  messagingSenderId: "246546066579",
  appId: "1:246546066579:web:6ea8d60a15e979c824b166",
  measurementId: "G-RB47KWVBDV"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
let currentUser = null;
let personen = [];
let uploadedFiles = [];

// SPLASH
setTimeout(() => {
  document.getElementById('splashScreen').classList.add('hide');
  setTimeout(() => document.getElementById('splashScreen').style.display = 'none', 500);
}, 2000);

// THEME
const html = document.documentElement;
const toggleBtn = document.getElementById('themeToggle');
const logoLight = document.getElementById('logoLight');
const logoDark = document.getElementById('logoDark');
function applyTheme(theme) {
  html.setAttribute('data-theme', theme);
  localStorage.setItem('theme', theme);
  if (theme === 'dark') {
    toggleBtn.textContent = 'â˜€ï¸';
    logoLight.style.display = 'none';
    logoDark.style.display = 'block';
  } else {
    toggleBtn.textContent = 'ğŸŒ™';
    logoLight.style.display = 'block';
    logoDark.style.display = 'none';
  }
}
const savedTheme = localStorage.getItem('theme') || 'light';
applyTheme(savedTheme);
toggleBtn.addEventListener('click', () => applyTheme(html.getAttribute('data-theme') === 'light' ? 'dark' : 'light'));

// AUTH
auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    document.getElementById('loginScreen').classList.remove('show');
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('bottomNav').style.display = 'flex';
    document.getElementById('userName').textContent = user.displayName || user.email;
    document.getElementById('userAvatar').src = user.photoURL || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%2300c9a7"/><text x="50" y="50" text-anchor="middle" dominant-baseline="central" font-size="40" fill="white" font-family="sans-serif">ğŸ‘¤</text></svg>';
    startSync();
    loadPersonen();
  } else {
    document.getElementById('loginScreen').classList.add('show');
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('bottomNav').style.display = 'none';
  }
});

document.getElementById('googleLoginBtn').addEventListener('click', async () => {
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
  } catch (error) {
    alert('Login fehlgeschlagen: ' + error.message);
  }
});

document.getElementById('logoutBtn').addEventListener('click', () => {
  if (confirm('Wirklich abmelden?')) auth.signOut();
});

// NAVIGATION
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.getElementById('nav-stats').classList.toggle('active', id === 'statsSection');
  document.getElementById('nav-personen').classList.toggle('active', id === 'personenSection');
  document.getElementById('nav-new').classList.toggle('active', id === 'newBelegSection');
  document.getElementById('nav-manual').classList.toggle('active', id === 'manualSection');
  window.scrollTo(0, 0);
  
  // Personen-Dropdown aktualisieren wenn manuelle Sektion geÃ¶ffnet wird
  if (id === 'manualSection') {
    updateManualPersonenDropdown();
  }
}

// SYNC BELEGE
function startSync() {
  if (!currentUser) return;
  db.ref('users/' + currentUser.uid + '/belege').on('value', snap => {
    const d = snap.val() || {};
    const b = Object.values(d).sort((a, b) => new Date(b.erstellt) - new Date(a.erstellt));
    renderBelege(b);
    stats(b);
  });
}

// PERSONEN
function loadPersonen() {
  if (!currentUser) return;
  db.ref('users/' + currentUser.uid + '/personen').on('value', snap => {
    const d = snap.val() || {};
    personen = Object.values(d);
    renderPersonen(personen);
  });
}

function renderPersonen(p) {
  const el = document.getElementById('personenListe');
  if (!p.length) {
    el.innerHTML = '<div class="no-belege">Noch keine Personen angelegt</div>';
    return;
  }
  el.innerHTML = p.map(person => `
    <div class="person-item">
      <div>
        <div class="person-name">${person.name}</div>
        <div class="person-satz">${person.satz}% Beihilfe</div>
      </div>
      <button class="person-del" onclick="deletePerson('${person.id}')">ğŸ—‘ï¸</button>
    </div>
  `).join('');
}

let newPersonSatz = null;
function selectNewPersonSatz(s) {
  newPersonSatz = s;
  document.getElementById('newPersonSatz').value = s;
  document.querySelectorAll('#personenSection .satz-btn').forEach(b => {
    b.className = 'satz-btn';
    if (parseInt(b.dataset.s) === s) b.classList.add('s' + s);
  });
}

async function addPerson() {
  const name = document.getElementById('newPersonName').value.trim();
  if (!name) { alert('âš ï¸ Bitte Namen eingeben'); return; }
  if (!newPersonSatz) { alert('âš ï¸ Bitte Beihilfesatz wÃ¤hlen'); return; }
  const id = Date.now().toString();
  try {
    await db.ref('users/' + currentUser.uid + '/personen/' + id).set({ id, name, satz: newPersonSatz });
    document.getElementById('newPersonName').value = '';
    newPersonSatz = null;
    document.querySelectorAll('#personenSection .satz-btn').forEach(b => b.className = 'satz-btn');
  } catch (e) {
    alert('âŒ Fehler: ' + e.message);
  }
}

async function deletePerson(id) {
  if (!confirm('Person wirklich lÃ¶schen?')) return;
  try {
    await db.ref('users/' + currentUser.uid + '/personen/' + id).remove();
  } catch (e) {
    alert('âŒ Fehler: ' + e.message);
  }
}

// UPLOAD & OCR
document.getElementById('uploadArea').addEventListener('click', () => document.getElementById('fileInput').click());

document.getElementById('fileInput').addEventListener('change', async (e) => {
  const files = Array.from(e.target.files);
  if (!files.length) return;
  
  uploadedFiles = files;
  
  // Preview anzeigen
  const preview = document.getElementById('uploadPreview');
  preview.innerHTML = files.map((f, i) => `
    <div class="upload-preview-item">
      <img src="${URL.createObjectURL(f)}" id="preview-${i}">
      <button class="upload-preview-remove" onclick="removeUpload(${i})">Ã—</button>
    </div>
  `).join('');
  
  // OCR starten
  await processOCR(files);
});

function removeUpload(idx) {
  uploadedFiles.splice(idx, 1);
  if (!uploadedFiles.length) {
    document.getElementById('uploadPreview').innerHTML = '';
    document.getElementById('ocrProgress').style.display = 'none';
    document.getElementById('zuordnungContainer').innerHTML = '';
    document.getElementById('saveBelegeBtn').style.display = 'none';
  }
}

async function processOCR(files) {
  const progressEl = document.getElementById('ocrProgress');
  progressEl.style.display = 'block';
  progressEl.innerHTML = '<div style="text-align:center;padding:10px;color:var(--accent)">ğŸ”„ Starte OCR mit Bildoptimierung...</div>';
  
  const results = [];
  
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    progressEl.innerHTML += `<div class="ocr-item" id="ocr-${i}">
      <div class="ocr-status processing">ğŸ”„ Optimiere Bild ${i + 1}/${files.length}...</div>
    </div>`;
    
    try {
      // Bild vorverarbeiten fÃ¼r bessere OCR
      const processedImage = await preprocessImage(file);
      
      document.getElementById(`ocr-${i}`).querySelector('.ocr-status').textContent = 
        `ğŸ”„ Scanne Rechnung ${i + 1}/${files.length}...`;
      
      const { data: { text } } = await Tesseract.recognize(processedImage, 'deu', {
        logger: m => {
          if (m.status === 'recognizing text') {
            const pct = Math.round(m.progress * 100);
            document.getElementById(`ocr-${i}`).querySelector('.ocr-status').textContent = 
              `ğŸ”„ Scanne Rechnung ${i + 1}/${files.length}... ${pct}%`;
          }
        }
      });
      
      document.getElementById(`ocr-${i}`).querySelector('.ocr-status').className = 'ocr-status done';
      document.getElementById(`ocr-${i}`).querySelector('.ocr-status').textContent = 
        `âœ… Rechnung ${i + 1} gescannt`;
      
      // Namen finden
      const foundPerson = findPerson(text);
      // Betrag finden
      const foundBetrag = findBetrag(text);
      // Aussteller finden
      const foundAussteller = findAussteller(text);
      results.push({
        file,
        text,
        person: foundPerson,
        betrag: foundBetrag,
        aussteller: foundAussteller,
        index: i
      });
    } catch (err) {
      document.getElementById(`ocr-${i}`).querySelector('.ocr-status').textContent = 
        `âŒ Fehler bei Rechnung ${i + 1}`;
    }
  }
  
  // Zuordnung anzeigen
  showZuordnung(results);
}

// Bildvorverarbeitung fÃ¼r bessere OCR-Erkennung
async function preprocessImage(file) {
  return new Promise((resolve) => {
    const img = new Image();
    const reader = new FileReader();
    
    reader.onload = (e) => {
      img.onload = () => {
        // Canvas erstellen
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // GrÃ¶ÃŸe erhÃ¶hen fÃ¼r bessere Erkennung (aber nicht zu groÃŸ)
        let width = img.width;
        let height = img.height;
        const maxSize = 2000;
        
        if (width > maxSize || height > maxSize) {
          const ratio = Math.min(maxSize / width, maxSize / height);
          width = width * ratio;
          height = height * ratio;
        } else if (width < 1000) {
          // Zu kleine Bilder hochskalieren
          const ratio = 1000 / width;
          width = width * ratio;
          height = height * ratio;
        }
        
        canvas.width = width;
        canvas.height = height;
        
        // Bild zeichnen
        ctx.drawImage(img, 0, 0, width, height);
        
        // Bildverbesserungen anwenden
        const imageData = ctx.getImageData(0, 0, width, height);
        const data = imageData.data;
        
        // 1. Kontrast erhÃ¶hen + Graustufen
        for (let i = 0; i < data.length; i += 4) {
          // Graustufen
          const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
          
          // Kontrast erhÃ¶hen (Threshold)
          const threshold = 128;
          const factor = 1.5;
          let value = (gray - threshold) * factor + threshold;
          value = Math.max(0, Math.min(255, value));
          
          data[i] = value;     // R
          data[i + 1] = value; // G
          data[i + 2] = value; // B
        }
        
        ctx.putImageData(imageData, 0, 0);
        
        // Als Blob zurÃ¼ckgeben
        canvas.toBlob((blob) => {
          resolve(blob);
        }, 'image/png');
      };
      img.src = e.target.result;
    };
    
    reader.readAsDataURL(file);
  });
}

function findPerson(text) {
  if (!personen.length) return null;
  
  const textLower = text.toLowerCase();
  
  for (const person of personen) {
    const nameParts = person.name.toLowerCase().split(' ');
    
    // VollstÃ¤ndiger Name
    if (textLower.includes(person.name.toLowerCase())) {
      return { ...person, confidence: 100 };
    }
    
    // Alle Namensteile vorhanden
    if (nameParts.every(part => textLower.includes(part))) {
      return { ...person, confidence: 90 };
    }
    
    // Nachname + erster Buchstabe Vorname (z.B. "M. Mustermann")
    if (nameParts.length >= 2) {
      const initial = nameParts[0][0];
      const lastName = nameParts[nameParts.length - 1];
      if (textLower.includes(initial) && textLower.includes(lastName)) {
        return { ...person, confidence: 75 };
      }
    }
  }
  
  return null;
}

function findBetrag(text) {
  // Regex fÃ¼r GeldbetrÃ¤ge: 45,00 oder 45.00 oder 45,00â‚¬ oder EUR 45,00 etc.
  const betragPatterns = [
    /(?:gesamt|summe|total|betrag|zu zahlen|endbetrag)[\s:]*â‚¬?\s*([\d]+[.,][\d]{2})/i,
    /(?:gesamt|summe|total|betrag|zu zahlen|endbetrag)[\s:]*\s*([\d]+[.,][\d]{2})\s*â‚¬/i,
    /([\d]+[.,][\d]{2})\s*â‚¬/g,
    /â‚¬\s*([\d]+[.,][\d]{2})/g,
    /EUR\s*([\d]+[.,][\d]{2})/gi,
    /([\d]+[.,][\d]{2})\s*EUR/gi
  ];
  
  const betraege = [];
  
  // Keywords die auf Endbetrag hindeuten
  const endKeywords = ['gesamt', 'summe', 'total', 'zu zahlen', 'endbetrag', 'rechnungsbetrag'];
  
  for (const pattern of betragPatterns) {
    let matches;
    if (pattern.global) {
      matches = [...text.matchAll(pattern)];
      matches.forEach(match => {
        const betrag = parseFloat(match[1].replace(',', '.'));
        if (betrag > 0 && betrag < 100000) {
          // PrÃ¼fen ob Keyword in der NÃ¤he
          const pos = match.index;
          const context = text.substring(Math.max(0, pos - 50), pos).toLowerCase();
          const hasKeyword = endKeywords.some(kw => context.includes(kw));
          betraege.push({ betrag, hasKeyword, pos });
        }
      });
    } else {
      const match = text.match(pattern);
      if (match) {
        const betrag = parseFloat(match[1].replace(',', '.'));
        if (betrag > 0 && betrag < 100000) {
          betraege.push({ betrag, hasKeyword: true, pos: match.index });
        }
      }
    }
  }
  
  if (betraege.length === 0) return null;
  
  // Bevorzuge BetrÃ¤ge mit Keywords, sonst den grÃ¶ÃŸten Betrag
  const mitKeyword = betraege.filter(b => b.hasKeyword);
  if (mitKeyword.length > 0) {
    // Nimm den ersten mit Keyword (meist der Endbetrag)
    return mitKeyword[0].betrag;
  }
  
  // Sonst nimm den grÃ¶ÃŸten gefundenen Betrag
  return betraege.sort((a, b) => b.betrag - a.betrag)[0].betrag;
}

function findAussteller(text) {
  // Zeilen aufsplitten
  const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
  
  // Keywords die auf Rechnungsaussteller hindeuten
  const ausstellerKeywords = [
    'praxis', 'arzt', 'Ã¤rztin', 'zahnarzt', 'zahnÃ¤rztin', 'dr.', 'dr ', 
    'apotheke', 'krankenhaus', 'klinik', 'klinikum',
    'physiotherapie', 'ergotherapie', 'logopÃ¤die',
    'labor', 'laboratorium', 'institut',
    'therapie', 'zentrum', 'mvz', 'gesundheitszentrum',
    'facharzt', 'fachÃ¤rztin', 'gemeinschaftspraxis',
    'med.', 'medizin', 'chirurgie', 'orthopÃ¤die',
    'augenklinik', 'augenarzt', 'hautarzt', 'kinderarzt'
  ];
  
  // PrÃ¼fe die ersten 10 Zeilen (Aussteller meist am Anfang)
  const firstLines = lines.slice(0, 10);
  
  for (let i = 0; i < firstLines.length; i++) {
    const line = firstLines[i].toLowerCase();
    
    // PrÃ¼fe ob Zeile Keywords enthÃ¤lt
    const hasKeyword = ausstellerKeywords.some(kw => line.includes(kw));
    
    if (hasKeyword) {
      // Nimm diese Zeile und eventuell die nÃ¤chste
      let aussteller = firstLines[i];
      
      // Wenn nÃ¤chste Zeile kurz ist und keine PLZ/Adresse, hinzufÃ¼gen
      if (i + 1 < firstLines.length) {
        const nextLine = firstLines[i + 1];
        // PrÃ¼fe ob es keine Adresszeile ist (keine Zahlen am Anfang, keine PLZ)
        if (!nextLine.match(/^\d/) && !nextLine.match(/\d{5}/) && nextLine.length < 40) {
          aussteller += ' ' + nextLine;
        }
      }
      
      // Bereinige den Aussteller
      aussteller = aussteller
        .replace(/rechnung/gi, '')
        .replace(/invoice/gi, '')
        .replace(/beleg/gi, '')
        .trim();
      
      // Maximal 60 Zeichen
      if (aussteller.length > 60) {
        aussteller = aussteller.substring(0, 60) + '...';
      }
      
      return aussteller;
    }
  }
  
  // Fallback: Wenn nichts gefunden, nimm die erste nicht-leere Zeile (oft Firmenname)
  if (lines.length > 0 && lines[0].length > 3 && lines[0].length < 50) {
    return lines[0];
  }
  
  return null;
}

function showZuordnung(results) {
  const container = document.getElementById('zuordnungContainer');
  const heute = new Date().toISOString().split('T')[0];
  
  container.innerHTML = results.map((r, idx) => `
    <div class="zuordnung-card" id="zuordnung-${idx}">
      <img src="${URL.createObjectURL(r.file)}" class="zuordnung-img">
      <div class="form-group">
        <label class="form-label">Person zuordnen</label>
        ${r.person ? `<div class="zuordnung-suggestion">âœ¨ ${r.person.name} erkannt (${r.person.satz}%)</div>` : ''}
        <select class="zuordnung-dropdown" id="person-${idx}">
          ${r.person ? `<option value="${r.person.id}" selected>${r.person.name} (${r.person.satz}%)</option>` : '<option value="">-- Bitte wÃ¤hlen --</option>'}
          ${personen.filter(p => !r.person || p.id !== r.person.id).map(p => `<option value="${p.id}">${p.name} (${p.satz}%)</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Betrag (â‚¬)</label>
        ${r.betrag ? `<div class="zuordnung-suggestion">âœ¨ ${r.betrag.toFixed(2).replace('.', ',')} â‚¬ erkannt</div>` : ''}
        <input type="number" step="0.01" min="0" placeholder="0,00" id="betrag-${idx}" value="${r.betrag || ''}">
      </div>
      <div class="form-group">
        <label class="form-label">Datum</label>
        <div class="zuordnung-suggestion">ğŸ“… Heute (${new Date().toLocaleDateString('de-DE')})</div>
        <input type="date" id="datum-${idx}" value="${heute}">
      </div>
      <div class="form-group">
        <label class="form-label">Beschreibung</label>
        ${r.aussteller ? `<div class="zuordnung-suggestion">âœ¨ ${r.aussteller} erkannt</div>` : ''}
        <input type="text" placeholder="Optional" id="beschreibung-${idx}" value="${r.aussteller || ''}">
      </div>
    </div>
  `).join('');
  
  document.getElementById('saveBelegeBtn').style.display = 'block';
}

async function saveBelege() {
  if (!currentUser) return;
  
  const btn = document.getElementById('saveBelegeBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Speichere...';
  
  try {
    for (let i = 0; i < uploadedFiles.length; i++) {
      const personId = document.getElementById(`person-${i}`).value;
      const betrag = parseFloat(document.getElementById(`betrag-${i}`).value);
      const datum = document.getElementById(`datum-${i}`).value;
      const beschreibung = document.getElementById(`beschreibung-${i}`).value;
      
      if (!personId || !betrag || !datum) {
        alert(`âš ï¸ Bitte alle Pflichtfelder fÃ¼r Rechnung ${i + 1} ausfÃ¼llen`);
        btn.disabled = false;
        btn.innerHTML = 'ğŸ’¾ Alle Belege speichern';
        return;
      }
      
      const person = personen.find(p => p.id === personId);
      const pct = person.satz / 100;
      const file = uploadedFiles[i];
      
      // Bild zu Base64
      const imgBase64 = await new Promise((res) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.readAsDataURL(file);
      });
      
      const id = Date.now().toString() + '-' + i;
      const beleg = {
        id,
        personId: person.id,
        personName: person.name,
        beihilfeSatz: person.satz,
        betrag,
        datum,
        beschreibung,
        beihilfeBetrag: betrag * pct,
        pkvBetrag: betrag * (1 - pct),
        dateiname: file.name,
        image: imgBase64,
        beihilfeBezahlt: false,
        pkvBezahlt: false,
        erstellt: new Date().toISOString()
      };
      
      await db.ref('users/' + currentUser.uid + '/belege/' + id).set(beleg);
    }
    
    // Reset
    uploadedFiles = [];
    document.getElementById('uploadPreview').innerHTML = '';
    document.getElementById('ocrProgress').style.display = 'none';
    document.getElementById('zuordnungContainer').innerHTML = '';
    document.getElementById('saveBelegeBtn').style.display = 'none';
    document.getElementById('fileInput').value = '';
    
    showSection('statsSection');
    alert('âœ… Alle Belege gespeichert!');
  } catch (err) {
    alert('âŒ Fehler: ' + err.message);
  }
  
  btn.disabled = false;
  btn.innerHTML = 'ğŸ’¾ Alle Belege speichern';
}

// DELETE / STATUS
window.deleteBeleg = async id => {
  if (!confirm('LÃ¶schen?') || !currentUser) return;
  try { await db.ref('users/' + currentUser.uid + '/belege/' + id).remove(); } catch (e) { alert(e.message); }
};

window.toggleStatus = async (id, field, val) => {
  if (!currentUser) return;
  try { await db.ref('users/' + currentUser.uid + '/belege/' + id + '/' + field).set(val); } catch (e) {}
};

// RENDER
function renderBelege(belege) {
  const el = document.getElementById('belegeListe');
  if (!belege.length) {
    el.innerHTML = '<div class="no-belege">Noch keine Belege.<br>Tippen Sie unten auf â•</div>';
    return;
  }
  el.innerHTML = belege.map(b => `
    <div class="beleg-item">
      <div class="beleg-top">
        <div>
          <span class="beleg-badge badge-${b.beihilfeSatz}">${b.personName || 'Unbekannt'} (${b.beihilfeSatz}%)</span>
          ${b.beschreibung ? `<div class="beleg-desc">${b.beschreibung}</div>` : ''}
          <div class="beleg-date">ğŸ“… ${datFmt(b.datum)}</div>
        </div>
        <button class="del-btn" onclick="deleteBeleg('${b.id}')">ğŸ—‘ï¸</button>
      </div>
      ${b.image ? `<img src="${b.image}" class="preview-img" style="display:block">` : ''}
      <div class="beleg-amounts">
        <div class="amt-item"><div class="amt-lbl">Rechnung</div><div class="amt-val av-accent">${eur(b.betrag)}</div></div>
        <div class="amt-item"><div class="amt-lbl">Beihilfe</div><div class="amt-val av-green">${eur(b.beihilfeBetrag)}</div></div>
        <div class="amt-item"><div class="amt-lbl">PKV</div><div class="amt-val av-blue">${eur(b.pkvBetrag)}</div></div>
      </div>
      <div class="status-row">
        <div class="check-toggle ${b.beihilfeBezahlt ? 'on-b' : ''}" onclick="toggleStatus('${b.id}','beihilfeBezahlt',${!b.beihilfeBezahlt})">${b.beihilfeBezahlt ? 'âœ…' : 'â¬œ'} Beihilfe bezahlt</div>
        <div class="check-toggle ${b.pkvBezahlt ? 'on-p' : ''}" onclick="toggleStatus('${b.id}','pkvBezahlt',${!b.pkvBezahlt})">${b.pkvBezahlt ? 'âœ…' : 'â¬œ'} PKV bezahlt</div>
      </div>
    </div>`).join('');
}

function stats(b) {
  document.getElementById('totalAmount').textContent = eur(b.reduce((s, x) => s + x.betrag, 0));
  document.getElementById('totalBeihilfe').textContent = eur(b.reduce((s, x) => s + x.beihilfeBetrag, 0));
  document.getElementById('totalPKV').textContent = eur(b.reduce((s, x) => s + x.pkvBetrag, 0));
}

function eur(v) {
  return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(v);
}

function datFmt(d) {
  return new Date(d).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MANUELLER MODUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let manualImgB64 = null, manualFileName = null;

function updateManualPersonenDropdown() {
  const select = document.getElementById('manualPerson');
  select.innerHTML = '<option value="">-- Bitte wÃ¤hlen --</option>' + 
    personen.map(p => `<option value="${p.id}">${p.name} (${p.satz}%)</option>`).join('');
}

document.getElementById('manualUploadArea').addEventListener('click', () => 
  document.getElementById('manualFileInput').click()
);

document.getElementById('manualFileInput').addEventListener('change', e => {
  const f = e.target.files[0];
  if (!f) return;
  manualFileName = f.name;
  document.getElementById('manualUploadedName').textContent = 'ğŸ“ ' + f.name;
  if (f.type.startsWith('image/')) {
    const r = new FileReader();
    r.onload = ev => {
      manualImgB64 = ev.target.result;
      const img = document.getElementById('manualPreviewImg');
      img.src = ev.target.result;
      img.style.display = 'block';
    };
    r.readAsDataURL(f);
  } else {
    manualImgB64 = null;
    document.getElementById('manualPreviewImg').style.display = 'none';
  }
});

function setManualHeute() {
  document.getElementById('manualDatum').value = new Date().toISOString().split('T')[0];
}

function calcManual() {
  const personId = document.getElementById('manualPerson').value;
  const betrag = parseFloat(document.getElementById('manualBetrag').value) || 0;
  
  if (!personId || betrag <= 0) {
    document.getElementById('manualCalcBox').classList.remove('show');
    return;
  }
  
  const person = personen.find(p => p.id === personId);
  if (!person) return;
  
  const pct = person.satz / 100;
  document.getElementById('manualRR').textContent = eur(betrag);
  document.getElementById('manualRB').textContent = eur(betrag * pct);
  document.getElementById('manualRP').textContent = eur(betrag * (1 - pct));
  document.getElementById('manualCalcBox').classList.add('show');
}

document.getElementById('manualPerson').addEventListener('change', calcManual);
document.getElementById('manualBetrag').addEventListener('input', calcManual);

document.getElementById('manualBelegForm').addEventListener('submit', async e => {
  e.preventDefault();
  if (!currentUser) { alert('âš ï¸ Bitte anmelden!'); return; }
  
  const btn = document.getElementById('manualSaveBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Speichere...';
  
  const personId = document.getElementById('manualPerson').value;
  const betrag = parseFloat(document.getElementById('manualBetrag').value);
  const datum = document.getElementById('manualDatum').value;
  const beschreibung = document.getElementById('manualBeschreibung').value;
  
  const person = personen.find(p => p.id === personId);
  const pct = person.satz / 100;
  const id = Date.now().toString();
  
  const beleg = {
    id,
    personId: person.id,
    personName: person.name,
    beihilfeSatz: person.satz,
    betrag,
    datum,
    beschreibung,
    beihilfeBetrag: betrag * pct,
    pkvBetrag: betrag * (1 - pct),
    dateiname: manualFileName,
    image: manualImgB64,
    beihilfeBezahlt: false,
    pkvBezahlt: false,
    erstellt: new Date().toISOString()
  };
  
  try {
    await db.ref('users/' + currentUser.uid + '/belege/' + id).set(beleg);
    e.target.reset();
    document.getElementById('manualCalcBox').classList.remove('show');
    document.getElementById('manualUploadedName').textContent = '';
    document.getElementById('manualPreviewImg').style.display = 'none';
    manualImgB64 = null;
    manualFileName = null;
    showSection('statsSection');
    alert('âœ… Beleg gespeichert!');
  } catch (err) {
    alert('âŒ Fehler: ' + err.message);
  }
  
  btn.disabled = false;
  btn.innerHTML = 'ğŸ’¾ Beleg speichern';
});
</script>
</body>
</html>
